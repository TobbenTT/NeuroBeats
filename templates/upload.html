{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos Dark Mode Pro */
    .form-control, .form-select {
        background-color: #2b2b2b;
        border: 1px solid #444;
        color: #e0e0e0;
    }
    .form-control:focus, .form-select:focus {
        background-color: #333;
        border-color: #7c4dff;
        box-shadow: 0 0 0 0.25rem rgba(124, 77, 255, 0.25);
        color: white;
    }
    .form-label { color: #b0b0b0; font-weight: 500; }
    #waveform-container { background-color: #1a1a1a; border: 1px solid #333; }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card bg-dark text-white border-0 shadow-lg rounded-4 overflow-hidden">
                
                <div class="card-header p-4" style="background: linear-gradient(45deg, #3a1c71, #d76d77, #ffaf7b);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0 fw-bold text-white"><i class="fas fa-rocket me-2"></i> Estudio de Subida</h3>
                        <span class="badge bg-black bg-opacity-50 rounded-pill px-3 py-2">
                            <i class="fas fa-wave-square me-1"></i> Modo Editor
                        </span>
                    </div>
                </div>

                <div class="card-body p-4 p-md-5" style="background-color: #121212;">
                    <form method="post" enctype="multipart/form-data" id="upload-form">
                        {% csrf_token %}
                        
                        <h5 class="text-white mb-4 pb-2 border-bottom border-secondary"><i class="fas fa-info-circle me-2"></i> Información</h5>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label">Título</label>
                                {{ form.title }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Artista</label>
                                {{ form.artist }}
                            </div>
                        </div>
                        <div class="mb-5">
                            <label class="form-label">Género</label>
                            {{ form.genre }}
                        </div>

                        <h5 class="text-white mb-4 pb-2 border-bottom border-secondary"><i class="fas fa-headphones me-2"></i> Recorte (30s)</h5>
                        <div class="mb-4 p-4 rounded-3" style="background-color: #1a1a1a; border: 1px dashed #555;">
                            <label class="form-label text-primary fw-bold mb-3">
                                <i class="fas fa-file-audio fa-lg me-2"></i> 1. Selecciona el archivo
                            </label>
                            {{ form.audio_file }}
                            
                            <div id="waveform-container" class="mt-4 p-3 rounded-3 d-none">
                                <div class="d-flex align-items-center text-info small mb-2">
                                    <i class="fas fa-cut me-2"></i>
                                    <span>Arrastra la caja azul para elegir el fragmento.</span>
                                </div>
                                <div id="waveform" class="mb-3"></div>
                                
                                <div class="d-flex justify-content-between align-items-center bg-black bg-opacity-25 p-2 rounded">
                                    <button type="button" id="btn-play" class="btn btn-sm btn-primary btn-neuro">
                                        <i class="fas fa-play me-1"></i> Preescuchar Recorte
                                    </button>
                                    <span class="badge bg-dark border border-secondary text-white fs-6" id="time-display">
                                        <i class="far fa-clock me-1"></i> 0.0s - 30.0s
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label">Portada</label>
                            {{ form.cover_image }}
                        </div>

                        {{ form.start_time }}
                        {{ form.end_time }}



                        <div class="d-grid gap-3 mt-5">
                            <button type="submit" class="btn btn-success btn-lg fw-bold py-3" style="background-color: #00c853; border: none;">
                                <i class="fas fa-check-circle fa-lg me-2"></i> Publicar Canción
                            </button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary py-2">Cancelar</a>
                        </div>
                    </form>
                                            <div class="form-check d-flex align-items-center gap-3">

                            {{ form.is_private }}

                            <div>
                                <label class="form-check-label fw-bold text-white" for="id_is_private">
                                    Marcar como Privada
                                </label>
                                <p class="text-muted small mb-0">Solo tú podrás ver y escuchar esta canción.</p>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/wavesurfer.js@7"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioInput = document.getElementById('audio-input');
        const container = document.getElementById('waveform-container');
        const playBtn = document.getElementById('btn-play');
        const timeDisplay = document.getElementById('time-display');
        const inputStart = document.getElementById('id_start_time');
        const inputEnd = document.getElementById('id_end_time');

        let wavesurfer;
        let wsRegions;

        audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                container.classList.remove('d-none');
                if (wavesurfer) wavesurfer.destroy();

                wavesurfer = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: '#5e35b1',
                    progressColor: '#b39ddb',
                    cursorColor: '#fff',
                    barWidth: 2,
                    height: 100,
                    url: URL.createObjectURL(file),
                });

                wsRegions = wavesurfer.registerPlugin(WaveSurfer.Regions.create());

                wavesurfer.on('decode', () => {
                    wsRegions.clearRegions();
                    wsRegions.addRegion({
                        start: 0, end: 30,
                        color: 'rgba(0, 200, 83, 0.35)',
                        drag: true, resize: true, maxLength: 30
                    });
                    if(inputStart) inputStart.value = 0;
                    if(inputEnd) inputEnd.value = 30;
                });

                wsRegions.on('region-updated', (region) => {
                    if(inputStart) inputStart.value = region.start.toFixed(2);
                    if(inputEnd) inputEnd.value = region.end.toFixed(2);
                    timeDisplay.innerHTML = `<i class="far fa-clock me-1"></i> ${region.start.toFixed(1)}s - ${region.end.toFixed(1)}s`;
                });

                playBtn.onclick = () => {
                    if (wavesurfer.isPlaying()) {
                        wavesurfer.pause();
                    } else {
                        const regions = wsRegions.getRegions();
                        if (regions.length > 0) regions[0].play();
                        else wavesurfer.play();
                    }
                };

                wavesurfer.on('play', () => {
                    playBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pausar';
                    playBtn.classList.remove('btn-primary');
                    playBtn.classList.add('btn-warning');
                });

                wavesurfer.on('pause', () => {
                    playBtn.innerHTML = '<i class="fas fa-play me-1"></i> Preescuchar Recorte';
                    playBtn.classList.remove('btn-warning');
                    playBtn.classList.add('btn-primary');
                });
            }
        }); // <--- AQUÍ TERMINA LA LÓGICA DEL AUDIO

        // --- LÓGICA FINAL ANTI-SPAM (REGRESO AL BOTÓN) ---
        const form = document.getElementById('upload-form');
        const submitBtn = document.querySelector('button[type="submit"]');

        if (form && submitBtn) {
            form.addEventListener('submit', function() {
                // 1. Cambiar texto y icono del botón
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Subiendo y Procesando...';
                
                // 2. Bloquear y oscurecer el botón
                submitBtn.disabled = true; 
                submitBtn.classList.add('disabled');
                submitBtn.style.opacity = '0.8';
                submitBtn.style.cursor = 'default';
                submitBtn.style.pointerEvents = 'none'; 
            });
        }
    });
</script>
{% endblock %}