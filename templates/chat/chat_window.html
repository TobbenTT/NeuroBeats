<div id="neuro-chat-wrapper">
    <!-- 1. Floating Button -->
    <button id="chat-toggle-btn"
        class="btn btn-neuro rounded-circle shadow-lg position-fixed d-flex align-items-center justify-content-center"
        style="bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 2000; transition: transform 0.2s;">
        <i class="fas fa-comments fa-lg"></i>
        <span id="chat-badge"
            class="position-absolute top-0 start-100 translate-middle p-2 bg-danger border border-light rounded-circle d-none">
            <span class="visually-hidden">New alerts</span>
        </span>
    </button>

    <!-- 2. Chat Window -->
    <div id="chat-window" class="card bg-dark border-secondary position-fixed shadow-lg d-none"
        style="bottom: 90px; right: 20px; width: 350px; height: 500px; z-index: 2000; border-radius: 15px; overflow: hidden;">

        <!-- Header -->
        <div
            class="card-header bg-black border-bottom border-secondary d-flex justify-content-between align-items-center p-3">
            <div class="d-flex align-items-center gap-2">
                <div class="position-relative">
                    <i class="fas fa-satellite-dish text-info" id="connection-icon"></i>
                    <span
                        class="position-absolute top-0 start-100 translate-middle p-1 bg-success border border-dark rounded-circle"
                        id="status-dot"></span>
                </div>
                <h6 class="mb-0 fw-bold text-white small text-uppercase">NeuroChat Global</h6>
            </div>
            <button id="chat-close-btn" class="btn btn-sm btn-link text-secondary p-0"><i
                    class="fas fa-times"></i></button>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="card-body p-3 overflow-auto custom-scrollbar"
            style="background: #111; height: 380px;">
            <div class="text-center text-muted small my-3">
                <i class="fas fa-shield-alt mb-2"></i><br>
                Bienvenido al chat global.<br>Sé respetuoso.
            </div>
            <!-- Messages go here -->
        </div>

        <!-- Input Area -->
        <div class="card-footer bg-black border-top border-secondary p-2">
            {% if user.is_authenticated %}
            <form id="chat-form" class="d-flex gap-2">
                <input type="text" id="chat-input"
                    class="form-control form-control-sm bg-dark text-white border-secondary rounded-pill"
                    placeholder="Escribe un mensaje..." autocomplete="off">
                <button type="submit" class="btn btn-sm btn-neuro rounded-circle" style="width: 32px; height: 32px;">
                    <i class="fas fa-paper-plane small"></i>
                </button>
            </form>
            {% else %}
            <div class="text-center small">
                <a href="{% url 'login' %}" class="text-info">Inicia sesión</a> para chatear.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatBtn = document.getElementById('chat-toggle-btn');
        const chatWindow = document.getElementById('chat-window');
        const closeBtn = document.getElementById('chat-close-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const messagesDiv = document.getElementById('chat-messages');
        const statusDot = document.getElementById('status-dot');
        const badge = document.getElementById('chat-badge');

        let socket = null;
        let isChatOpen = false;

        // --- UI Logic ---
        chatBtn.addEventListener('click', () => {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                chatWindow.classList.remove('d-none');
                badge.classList.add('d-none'); // Hide badge on open
                connectWebSocket();
                scrollToBottom();
            } else {
                chatWindow.classList.add('d-none');
            }
        });

        closeBtn.addEventListener('click', () => {
            isChatOpen = false;
            chatWindow.classList.add('d-none');
        });

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- WebSocket Logic ---
        function connectWebSocket() {
            if (socket && socket.readyState === WebSocket.OPEN) return;

            // Determine protocol (ws or wss)
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host + '/ws/chat/public/';

            console.log('Connecting to:', wsUrl); // Debug

            socket = new WebSocket(wsUrl);

            socket.onopen = function (e) {
                console.log('Chat connected');
                statusDot.classList.remove('bg-danger');
                statusDot.classList.add('bg-success');
            };

            socket.onclose = function (e) {
                console.log('Chat disconnected');
                statusDot.classList.remove('bg-success');
                statusDot.classList.add('bg-danger');
                // Reconnect strategy could go here
            };

            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);

                if (data.type === 'chat_message') {
                    appendMessage(data);
                    if (!isChatOpen) {
                        badge.classList.remove('d-none');
                    }
                } else if (data.type === 'user_status') {
                    // console.log('User status update:', data);
                    // Could show a notification "User X is online"
                }
            };
        }

        function appendMessage(data) {
            const isMe = data.username === "{{ user.username }}";
            const alignClass = isMe ? 'justify-content-end' : 'justify-content-start';
            const bgClass = isMe ? 'bg-neuro text-white' : 'bg-secondary bg-opacity-25 text-white';
            const roundedClass = isMe ? 'rounded-top rounded-start' : 'rounded-top rounded-end';

            const msgHtml = `
                <div class="d-flex ${alignClass} mb-3 gap-2">
                    ${!isMe ? `<img src="${data.avatar_url || '/static/img/default.png'}" width="25" height="25" class="rounded-circle">` : ''}
                    <div class="d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}" style="max-width: 80%;">
                        <div class="p-2 px-3 small ${bgClass} ${roundedClass}" style="border-radius: 12px; word-wrap: break-word;">
                            ${data.message}
                        </div>
                        <small class="text-muted" style="font-size: 0.6em;">${data.timestamp}</small>
                    </div>
                </div>
            `;

            messagesDiv.insertAdjacentHTML('beforeend', msgHtml);
            scrollToBottom();
        }

        if (chatForm) {
            chatForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const message = chatInput.value.trim();
                if (message && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        'message': message
                    }));
                    chatInput.value = '';
                }
            });
        }

        // Auto-connect if user is logged in (optional, for notifications)
        {% if user.is_authenticated %}
        // connectWebSocket(); // Uncomment to connect on load
        {% endif %}
    });
</script>