{% extends 'base.html' %}

{% block content %}
<style>
    /* Estilos del Vinilo */
    .record-player-container {
        position: relative;
        width: 100%;
        padding-top: 100%;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        background-color: #1a1a1a;
    }
    .record {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; background-position: center;
        border-radius: 50%; border: 8px solid #0a0a0a;
        box-shadow: inset 0 0 0 3px rgba(255,255,255,0.05), inset 0 0 0 8px rgba(0,0,0,0.4);
        transition: transform 0.5s ease-out;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .record.spinning { animation: spin 5s linear infinite; }
    
    .play-btn-center {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 50px; height: 50px;
        background-color: rgba(124, 77, 255, 0.9);
        border-radius: 50%; border: none; color: white;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 10; transition: all 0.2s;
    }
    .play-btn-center:hover { transform: translate(-50%, -50%) scale(1.1); background-color: #7c4dff; }
    .center-hole {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 15px; height: 15px; background-color: #0a0a0a; border-radius: 50%; z-index: 5;
    }

    /* Separadores */
    .section-title {
        border-left: 5px solid #7c4dff;
        padding-left: 15px;
        margin-bottom: 30px;
        margin-top: 20px;
    }
</style>

<div class="mb-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">üß† Seleccionado para Ti</h1>
        <p class="text-secondary">Basado en tus gustos y patrones de escucha.</p>
    </div>

    <div class="row justify-content-center">
        {% for song in recommended_songs %}
            {% include 'partials/song_card.html' %}
        {% empty %}
            <div class="text-center text-muted">
                <p>La IA est√° aprendiendo... Dale like a algunas canciones abajo.</p>
            </div>
        {% endfor %}
    </div>
</div>

<hr class="border-secondary my-5">

<div class="mb-5">
    <div class="section-title">
        <h2 class="fw-bold">üåç Explorar Todo</h2>
        <p class="text-muted small">Lo √∫ltimo de la comunidad.</p>
    </div>

    <div class="row">
        {% for song in explore_songs %}
            {% include 'partials/song_card.html' %}
        {% empty %}
            <p class="text-muted">No hay m√°s canciones en la plataforma.</p>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const playButtons = document.querySelectorAll('.play-btn-center');
        let currentlyPlayingAudio = null;
        let currentlySpinningRecord = null;
        let currentPlayBtn = null;

        playButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const songId = this.dataset.songId;
                const audio = document.getElementById(`audio-${songId}`);
                const record = document.getElementById(`record-${songId}`);
                const icon = this.querySelector('i');

                if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
                    currentlyPlayingAudio.pause();
                    currentlySpinningRecord.classList.remove('spinning');
                    currentPlayBtn.querySelector('i').classList.remove('fa-pause');
                    currentPlayBtn.querySelector('i').classList.add('fa-play');
                }

                if (audio.paused) {
                    audio.play();
                    record.classList.add('spinning');
                    icon.classList.remove('fa-play').add('fa-pause');
                    currentlyPlayingAudio = audio;
                    currentlySpinningRecord = record;
                    currentPlayBtn = this;
                } else {
                    audio.pause();
                    record.classList.remove('spinning');
                    icon.classList.remove('fa-pause').add('fa-play');
                    currentlyPlayingAudio = null;
                }
                audio.onended = () => {
                    record.classList.remove('spinning');
                    icon.classList.remove('fa-pause').add('fa-play');
                    currentlyPlayingAudio = null;
                };
            });
        });

        // Likes AJAX
        const favButtons = document.querySelectorAll('.btn-favorite');
        favButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const songId = this.dataset.id;
                const icon = this.querySelector('i');
                if (icon.classList.contains('far')) icon.classList.remove('far').add('fas');
                else icon.classList.remove('fas').add('far');

                fetch(`/favorite/${songId}/`).then(r => r.json());
            });
        });
    });
</script>
{% endblock %}